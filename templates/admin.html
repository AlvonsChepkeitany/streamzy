{% extends "base.html" %}

{% block title %}Streamzy - Admin Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="terminal-window fullscreen">
        <div class="terminal-header">
            <span class="terminal-title">ADMIN_TERMINAL :: CONTROL PANEL</span>
            <div class="terminal-controls">
                <a href="{{ url_for('chat') }}" class="control-btn" title="Back to Chat">
                    <span class="icon">üí¨</span>
                </a>
                <button class="control-btn danger" id="logoutBtn" title="Logout">
                    <span class="icon">‚èª</span>
                </button>
            </div>
        </div>
        
        <div class="terminal-body admin-body">
            <!-- Navigation Tabs -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="applications">
                    <span class="icon">üìù</span> APPLICATIONS
                    <span class="badge" id="pendingCount">0</span>
                </button>
                <button class="tab-btn" data-tab="rooms">
                    <span class="icon">üìÅ</span> ROOMS
                </button>
                <button class="tab-btn" data-tab="users">
                    <span class="icon">üë•</span> USERS
                </button>
                <button class="tab-btn" data-tab="logs">
                    <span class="icon">üìã</span> AUDIT LOGS
                </button>
            </div>
            
            <!-- Applications Panel -->
            <div class="admin-panel" id="applicationsPanel">
                <div class="panel-header">
                    <h2>PENDING APPLICATIONS</h2>
                    <button class="refresh-btn" onclick="loadApplications()">
                        [ REFRESH ]
                    </button>
                </div>
                <div class="panel-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>EMAIL</th>
                                <th>DATE</th>
                                <th>STATUS</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTable">
                            <!-- Applications will be loaded here -->
                        </tbody>
                    </table>
                    <div class="empty-message hidden" id="noApplications">
                        No pending applications
                    </div>
                </div>
            </div>
            
            <!-- Rooms Panel -->
            <div class="admin-panel hidden" id="roomsPanel">
                <div class="panel-header">
                    <h2>ROOM MANAGEMENT</h2>
                    <div class="header-actions">
                        <button class="action-btn create" onclick="showCreateRoomModal()">
                            [ + CREATE ROOM ]
                        </button>
                        <button class="refresh-btn" onclick="loadRooms()">
                            [ REFRESH ]
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>DESCRIPTION</th>
                                <th>MEMBERS</th>
                                <th>CREATED</th>
                                <th>PASSWORD</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTable">
                            <!-- Rooms will be loaded here -->
                        </tbody>
                    </table>
                    <div class="empty-message hidden" id="noRooms">
                        No rooms created yet
                    </div>
                </div>
            </div>
            
            <!-- Users Panel -->
            <div class="admin-panel hidden" id="usersPanel">
                <div class="panel-header">
                    <h2>USER MANAGEMENT</h2>
                    <button class="refresh-btn" onclick="loadUsers()">
                        [ REFRESH ]
                    </button>
                </div>
                <div class="panel-content">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>USERNAME</th>
                                <th>CREATED</th>
                                <th>LAST ACTIVE</th>
                                <th>STATUS</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Audit Logs Panel -->
            <div class="admin-panel hidden" id="logsPanel">
                <div class="panel-header">
                    <h2>SECURITY AUDIT LOGS</h2>
                    <button class="refresh-btn" onclick="loadLogs()">
                        [ REFRESH ]
                    </button>
                </div>
                <div class="panel-content">
                    <div class="log-viewer" id="logViewer">
                        <!-- Logs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="terminal-footer">
            <span class="status-indicator online"></span>
            <span class="status-text">ADMIN ACCESS ACTIVE</span>
            <span class="admin-badge">üîê ELEVATED PRIVILEGES</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const panels = {
        'applications': document.getElementById('applicationsPanel'),
        'rooms': document.getElementById('roomsPanel'),
        'users': document.getElementById('usersPanel'),
        'logs': document.getElementById('logsPanel')
    };
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.dataset.tab;
            
            // Update active tab
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show panel
            Object.values(panels).forEach(p => p.classList.add('hidden'));
            panels[tab].classList.remove('hidden');
            
            // Load data
            if (tab === 'applications') loadApplications();
            else if (tab === 'rooms') loadRooms();
            else if (tab === 'users') loadUsers();
            else if (tab === 'logs') loadLogs();
        });
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async function() {
        await fetch('/api/logout', {
            method: 'POST',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        window.location.href = '/login';
    });
    
    // Load initial data
    loadApplications();
});

async function loadApplications() {
    try {
        const response = await fetch('/api/admin/applications', {
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        const data = await response.json();
        
        const tbody = document.getElementById('applicationsTable');
        const noApps = document.getElementById('noApplications');
        const pendingCount = document.getElementById('pendingCount');
        
        pendingCount.textContent = data.applications.length;
        
        if (data.applications.length === 0) {
            tbody.innerHTML = '';
            noApps.classList.remove('hidden');
            return;
        }
        
        noApps.classList.add('hidden');
        tbody.innerHTML = data.applications.map(app => `
            <tr>
                <td>${app.id}</td>
                <td>${escapeHtml(app.email)}</td>
                <td>${formatDate(app.created_at)}</td>
                <td><span class="status-badge ${app.status}">${app.status.toUpperCase()}</span></td>
                <td>
                    <button class="action-btn approve" onclick="approveApplication(${app.id})">
                        [ APPROVE ]
                    </button>
                    <button class="action-btn reject" onclick="rejectApplication(${app.id})">
                        [ REJECT ]
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Failed to load applications:', err);
    }
}

async function approveApplication(id) {
    if (!confirm('Approve this application?')) return;
    
    try {
        const response = await fetch(`/api/admin/applications/${id}/approve`, {
            method: 'POST',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Application approved! Username: ${data.user.username}`);
            loadApplications();
        } else {
            alert('Error: ' + (data.error || 'Failed to approve'));
        }
    } catch (err) {
        alert('Error approving application');
    }
}

async function rejectApplication(id) {
    const reason = prompt('Rejection reason (optional):');
    
    try {
        const response = await fetch(`/api/admin/applications/${id}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify({ reason: reason })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Application rejected');
            loadApplications();
        } else {
            alert('Error: ' + (data.error || 'Failed to reject'));
        }
    } catch (err) {
        alert('Error rejecting application');
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users', {
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        const data = await response.json();
        
        const tbody = document.getElementById('usersTable');
        
        tbody.innerHTML = data.users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${escapeHtml(user.username)} ${user.is_admin ? '<span class="admin-tag">ADMIN</span>' : ''}</td>
                <td>${formatDate(user.created_at)}</td>
                <td>${user.last_activity ? formatDate(user.last_activity) : 'Never'}</td>
                <td><span class="status-badge ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'ACTIVE' : 'INACTIVE'}</span></td>
                <td>
                    <button class="action-btn toggle" onclick="toggleUser(${user.id}, ${user.is_active})">
                        [ ${user.is_active ? 'DISABLE' : 'ENABLE'} ]
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Failed to load users:', err);
    }
}

async function toggleUser(id, currentStatus) {
    const action = currentStatus ? 'disable' : 'enable';
    if (!confirm(`${action.toUpperCase()} this user?`)) return;
    
    try {
        const response = await fetch(`/api/admin/users/${id}/toggle`, {
            method: 'POST',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadUsers();
        } else {
            alert('Error: ' + (data.error || 'Failed to toggle user'));
        }
    } catch (err) {
        alert('Error toggling user');
    }
}

// ========================================
// Room Management
// ========================================

async function loadRooms() {
    try {
        const response = await fetch('/api/admin/rooms', {
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        const data = await response.json();
        
        const tbody = document.getElementById('roomsTable');
        const noRooms = document.getElementById('noRooms');
        
        if (data.rooms.length === 0) {
            tbody.innerHTML = '';
            noRooms.classList.remove('hidden');
            return;
        }
        
        noRooms.classList.add('hidden');
        tbody.innerHTML = data.rooms.map(room => `
            <tr>
                <td>${room.id}</td>
                <td><strong>${escapeHtml(room.name)}</strong></td>
                <td>${escapeHtml(room.description || '-')}</td>
                <td>${room.member_count} / ${room.max_members}</td>
                <td>${formatDate(room.created_at)}</td>
                <td>
                    <button class="action-btn" onclick="resetRoomPassword(${room.id}, '${room.name}')">
                        [ RESET ]
                    </button>
                </td>
                <td>
                    <button class="action-btn" onclick="viewRoomMembers(${room.id}, '${room.name}')">
                        [ MEMBERS ]
                    </button>
                    <button class="action-btn reject" onclick="deleteRoom(${room.id}, '${room.name}')">
                        [ DELETE ]
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Failed to load rooms:', err);
    }
}

function showCreateRoomModal() {
    document.getElementById('createRoomModal').classList.remove('hidden');
    document.getElementById('newRoomName').focus();
}

function closeCreateRoomModal() {
    document.getElementById('createRoomModal').classList.add('hidden');
    document.getElementById('newRoomName').value = '';
    document.getElementById('newRoomDescription').value = '';
    document.getElementById('newRoomPassword').value = '';
    document.getElementById('createRoomError').classList.add('hidden');
}

async function createRoom() {
    const name = document.getElementById('newRoomName').value.trim();
    const description = document.getElementById('newRoomDescription').value.trim();
    const password = document.getElementById('newRoomPassword').value;
    const errorEl = document.getElementById('createRoomError');
    
    if (!name || !password) {
        errorEl.textContent = 'Room name and password are required';
        errorEl.classList.remove('hidden');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify({ name, description, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Room created successfully!\n\nRoom: ${data.room.name}\nPassword: ${data.password}\n\nShare this password with users who should join.`);
            closeCreateRoomModal();
            loadRooms();
        } else {
            errorEl.textContent = data.error || 'Failed to create room';
            errorEl.classList.remove('hidden');
        }
    } catch (err) {
        errorEl.textContent = 'Error creating room';
        errorEl.classList.remove('hidden');
    }
}

async function resetRoomPassword(roomId, roomName) {
    const newPassword = prompt(`Enter new password for room "${roomName}":`);
    if (!newPassword) return;
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/rooms/${roomId}/password`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify({ password: newPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Password reset successfully!\n\nNew password: ${data.password}`);
        } else {
            alert('Error: ' + (data.error || 'Failed to reset password'));
        }
    } catch (err) {
        alert('Error resetting password');
    }
}

async function viewRoomMembers(roomId, roomName) {
    try {
        const response = await fetch(`/api/admin/rooms/${roomId}/members`, {
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        const data = await response.json();
        
        if (data.members.length === 0) {
            alert(`Room "${roomName}" has no members yet.`);
            return;
        }
        
        const memberList = data.members.map(m => `- ${m.username} (joined: ${formatDate(m.joined_at)})`).join('\n');
        alert(`Members of "${roomName}":\n\n${memberList}`);
    } catch (err) {
        alert('Error loading members');
    }
}

async function deleteRoom(roomId, roomName) {
    if (!confirm(`DELETE room "${roomName}"?\n\nThis will remove all members and cannot be undone!`)) return;
    
    try {
        const response = await fetch(`/api/admin/rooms/${roomId}`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Room deleted');
            loadRooms();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete room'));
        }
    } catch (err) {
        alert('Error deleting room');
    }
}

async function loadLogs() {
    try {
        const response = await fetch('/api/admin/audit-logs?limit=100', {
            headers: { 'X-CSRFToken': window.CSRF_TOKEN }
        });
        const data = await response.json();
        
        const viewer = document.getElementById('logViewer');
        
        viewer.innerHTML = data.logs.map(log => `
            <div class="log-entry ${log.event_type.includes('failed') || log.event_type.includes('blocked') ? 'warning' : ''}">
                <span class="log-time">[${formatDate(log.created_at)}]</span>
                <span class="log-type">${log.event_type.toUpperCase()}</span>
                <span class="log-desc">${escapeHtml(log.description)}</span>
                <span class="log-ip">${log.ip_address || 'N/A'}</span>
            </div>
        `).join('');
    } catch (err) {
        console.error('Failed to load logs:', err);
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    return date.toLocaleString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<!-- Create Room Modal -->
<div class="modal hidden" id="createRoomModal">
    <div class="modal-content terminal-style">
        <div class="modal-header">
            <h3>CREATE NEW ROOM</h3>
            <button class="close-btn" onclick="closeCreateRoomModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Room Name:</label>
                <input type="text" id="newRoomName" placeholder="e.g., project_alpha" class="terminal-input">
                <small>Lowercase letters, numbers, underscores only</small>
            </div>
            <div class="form-group">
                <label>Description (optional):</label>
                <input type="text" id="newRoomDescription" placeholder="Brief description" class="terminal-input">
            </div>
            <div class="form-group">
                <label>Secret Password:</label>
                <input type="text" id="newRoomPassword" placeholder="Min 6 characters" class="terminal-input">
                <small>Share this password with users who should join</small>
            </div>
            <div class="error-msg hidden" id="createRoomError"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="createRoom()">CREATE ROOM</button>
            <button class="btn btn-secondary" onclick="closeCreateRoomModal()">CANCEL</button>
        </div>
    </div>
</div>
{% endblock %}
